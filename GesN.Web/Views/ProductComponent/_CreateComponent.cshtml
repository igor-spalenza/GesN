@model GesN.Web.Models.ViewModels.Production.CreateProductComponentViewModel
@using GesN.Web.Models.Enumerators

@* Incluir CSS específico do domínio Product *@
<link href="~/css/ProductDomain.css" rel="stylesheet" />

<form method="post">
    @Html.AntiForgeryToken()

    <div class="row">
        <!-- Nome do Componente -->
        <div class="col-md-6 mb-3">
            <div class="floating-input-group">
                <input asp-for="Name" type="text" 
                       class="form-control floating-input" 
                       placeholder=" " required maxlength="100" />
                <label asp-for="Name" class="floating-label">
                    <i class="fas fa-tag text-primary"></i>
                    Nome do Componente
                </label>
                <span asp-validation-for="Name" class="field-validation-valid text-danger"></span>
            </div>
        </div>

        <!-- Status -->
        <div class="col-md-6 mb-3">
            <div class="floating-input-group">
                <select asp-for="StateCode" class="form-select floating-select" required>
                    <option value="@((int)ObjectState.Active)" selected>Ativo</option>
                    <option value="@((int)ObjectState.Inactive)">Inativo</option>
                </select>
                <label asp-for="StateCode" class="floating-label">
                    <i class="fas fa-toggle-on text-primary"></i>
                    Status
                </label>
                <span asp-validation-for="StateCode" class="field-validation-valid text-danger"></span>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Hierarquia de Componentes (com autocomplete) -->
        <div class="col-12 mb-3">
            <div class="floating-input-group">
                <input type="text" 
                       id="ProductComponentHierarchyName" 
                       name="ProductComponentHierarchyName"
                       class="form-control floating-input autocomplete-input" 
                       placeholder=" " 
                       autocomplete="off"
                       data-component-name="@Model.Name" />
                <input type="hidden" 
                       asp-for="ProductComponentHierarchyId" 
                       id="ProductComponentHierarchyId" />
                <label for="ProductComponentHierarchyName" class="floating-label">
                    <i class="fas fa-sitemap text-primary"></i>
                    Hierarquia de Componentes
                </label>
                <span asp-validation-for="ProductComponentHierarchyId" class="field-validation-valid text-danger"></span>
                <div class="form-text">
                    <small class="text-muted">
                        <i class="fas fa-info-circle"></i>
                        Digite para buscar por hierarquias de componentes disponíveis
                    </small>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Custo Adicional -->
        <div class="col-md-6 mb-3">
            <div class="floating-input-group">
                <input asp-for="AdditionalCost" type="number" 
                       class="form-control floating-input" 
                       step="0.01" min="0" placeholder=" " />
                <label asp-for="AdditionalCost" class="floating-label">
                    <i class="fas fa-dollar-sign text-primary"></i>
                    Custo Adicional (R$)
                </label>
                <span asp-validation-for="AdditionalCost" class="field-validation-valid text-danger"></span>
                <div class="form-text">
                    <small class="text-muted">
                        <i class="fas fa-info-circle"></i>
                        Valor adicional específico para este componente
                    </small>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Descrição -->
        <div class="col-12 mb-3">
            <div class="floating-input-group">
                <textarea asp-for="Description" class="form-control floating-textarea" 
                          rows="3" maxlength="500" placeholder=" "></textarea>
                <label asp-for="Description" class="floating-label">
                    <i class="fas fa-align-left text-primary"></i>
                    Descrição (opcional)
                </label>
                <span asp-validation-for="Description" class="field-validation-valid text-danger"></span>
                <div class="form-text">
                    <small class="text-muted">
                        <i class="fas fa-info-circle"></i>
                        Máximo 500 caracteres. Descreva detalhes específicos do componente.
                    </small>
                </div>
            </div>
        </div>
    </div>

    <!-- Informações de Custo (será calculado dinamicamente se necessário) -->
    <div class="row">
        <div class="col-12">
            <div class="alert alert-info d-none" id="componentCostInfo">
                <div class="d-flex align-items-center">
                    <i class="fas fa-calculator fa-2x text-primary me-3"></i>
                    <div>
                        <h6 class="mb-1">
                            <i class="fas fa-dollar-sign"></i>
                            Resumo de Custos
                        </h6>
                        <div class="d-flex gap-3">
                            <span>
                                <strong>Custo Adicional:</strong> 
                                <span id="displayAdditionalCost" class="text-success">R$ 0,00</span>
                            </span>
                            <span>
                                <strong>Hierarquia:</strong> 
                                <span id="displayHierarchyName" class="text-primary">-</span>
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Botões do Modal -->
    <div class="modal-footer border-top pt-3 mt-3">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="fas fa-times"></i> Cancelar
        </button>
        <button type="button" class="btn btn-primary" onclick="productComponentsManager.salvarNovoModal()">
            <i class="fas fa-save"></i> Salvar Componente
        </button>
    </div>
</form>

<script>
$(document).ready(function() {
    // Inicializar autocomplete para ProductComponentHierarchy
    const hierarchyNameField = $('#ProductComponentHierarchyName');
    const hierarchyIdField = $('#ProductComponentHierarchyId');
    
    if (hierarchyNameField.length) {
        // Remove instância anterior se houver
        if (hierarchyNameField.data('aaAutocomplete')) {
            hierarchyNameField.autocomplete.destroy();
        }

        // Inicializar Algolia Autocomplete.js
        const autocompleteInstance = autocomplete(hierarchyNameField[0], {
            hint: false,
            debug: false,
            minLength: 2,
            openOnFocus: false,
            autoselect: true,
            appendTo: hierarchyNameField.closest('.modal-body, .tab-pane, body')[0]
        }, [{
            source: function(query, callback) {
                $.ajax({
                    url: '/ProductComponent/BuscarHierarchyAutocomplete',
                    type: 'GET',
                    dataType: 'json',
                    data: { termo: query },
                    success: function(data) {
                        const suggestions = $.map(data, function(item) {
                            return {
                                label: item.label,
                                value: item.value,
                                id: item.id,
                                description: item.description,
                                data: item
                            };
                        });
                        callback(suggestions);
                    },
                    error: function() {
                        callback([]);
                    }
                });
            },
            displayKey: 'label',
            templates: {
                suggestion: function(suggestion) {
                    return '<div class="autocomplete-suggestion">' +
                           '<div class="suggestion-title">' + (suggestion.data.name || suggestion.label) + '</div>' +
                           (suggestion.data.description ? '<div class="suggestion-subtitle">' + suggestion.data.description + '</div>' : '') +
                           '</div>';
                }
            }
        }]);

        // Handle selection for Hierarchy
        autocompleteInstance.on('autocomplete:selected', function(event, suggestion, dataset) {
            hierarchyIdField.val(suggestion.id);
            hierarchyNameField.val(suggestion.value);
            $('#displayHierarchyName').text(suggestion.value);
            
            // Mostrar informações de custo se houver valor
            updateCostDisplay();
        });

        // Limpar seleção se campo ficar vazio
        hierarchyNameField.on('blur', function() {
            if ($(this).val() === '') {
                hierarchyIdField.val('');
                $('#displayHierarchyName').text('-');
                updateCostDisplay();
            }
        });
    }

    // Atualizar display de custo quando custo adicional mudar
    $('#AdditionalCost').on('input', function() {
        updateCostDisplay();
    });

    function updateCostDisplay() {
        const additionalCost = parseFloat($('#AdditionalCost').val() || 0);
        const hierarchyName = $('#ProductComponentHierarchyName').val();
        
        $('#displayAdditionalCost').text('R$ ' + additionalCost.toFixed(2).replace('.', ','));
        
        if (additionalCost > 0 || hierarchyName) {
            $('#componentCostInfo').removeClass('d-none');
        } else {
            $('#componentCostInfo').addClass('d-none');
        }
    }
});
</script> 